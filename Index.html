<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Personas Interactivo</title>
    
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Iconos (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Fuentes personalizadas */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Creepster&family=Black+Ops+One&family=Press+Start+2P&display=swap');

        /* Definición de variables CSS para los temas */
        :root {
            --font-main: 'Chakra Petch', sans-serif;
        }

        body {
            font-family: var(--font-main);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Tema Gotico */
        body.theme-gothic {
            --bg-primary: #121212;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2c2c2c;
            --text-primary: #dcdcdc;
            --text-secondary: #a0a0a0;
            --accent-primary: #990000;
            --accent-secondary: #ff1111;
            --man-color: #8a0303;
            --woman-color: #4d0a4f;
            --font-display: 'Creepster', cursive;
            --text-on-accent: #FFFFFF;
        }

        /* Tema Rockero */
        body.theme-rocker {
            --bg-primary: #101010;
            --bg-secondary: #1E1E1E;
            --bg-tertiary: #282828;
            --text-primary: #FFFFFF;
            --text-secondary: #b3b3b3;
            --accent-primary: #D22B2B;
            --accent-secondary: #FF8C00;
            --man-color: #E03C31;
            --woman-color: #F46F30;
            --font-display: 'Black Ops One', cursive;
            --text-on-accent: #101010;
        }

        /* Tema Retro/Gaming */
        body.theme-retro {
            --bg-primary: #230a3b;
            --bg-secondary: #311152;
            --bg-tertiary: #451973;
            --text-primary: #e0e0e0;
            --text-secondary: #b0a8b9;
            --accent-primary: #f000b8;
            --accent-secondary: #00f0ff;
            --man-color: #00f0ff;
            --woman-color: #f000b8;
            --font-display: 'Press Start 2P', cursive;
            --text-on-accent: #230a3b;
        }

        /* Aplicación de variables */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .accent-primary { background-color: var(--accent-primary); }
        .accent-secondary { background-color: var(--accent-secondary); }
        .border-accent { border-color: var(--accent-primary); }
        .font-display { font-family: var(--font-display); }
        .text-on-accent { color: var(--text-on-accent); }
        
        /* Estilos para la sala y las personas */
        #room {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border: 2px solid var(--accent-primary);
            transition: border-color 0.5s ease;
        }

        .person {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            transition: transform 1s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 1;
        }
        
        .person.man { background-color: var(--man-color); }
        .person.woman { background-color: var(--woman-color); }
        
        .theme-retro .person {
            width: 12px;
            height: 12px;
            border-radius: 0;
            image-rendering: pixelated;
        }

        .person.entering { transform: scale(0.1); opacity: 0; }
        .person.leaving { transform: scale(0); opacity: 0; }
        
        .btn-theme.active {
            box-shadow: 0 0 15px var(--accent-secondary);
            transform: scale(1.1);
        }

        /* --- NUEVAS ANIMACIONES Y ESTILOS --- */
        .btn-control {
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
        }

        .btn-control:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            opacity: 0.9;
        }
        
        .flash-update {
            animation: flash 0.4s ease-out;
        }

        @keyframes flash {
            50% { color: var(--accent-secondary); transform: scale(1.15); }
            100% { color: var(--text-primary); transform: scale(1); }
        }

        /* Contenedor para que Chart.js se comporte correctamente */
        .chart-container {
            position: relative;
            height: 288px; /* 18rem o h-72 en Tailwind */
            width: 100%;
        }
    </style>
</head>
<body class="theme-gothic bg-primary text-primary">

    <div class="container mx-auto p-4 max-w-7xl">

        <!-- Cabecera y Selector de Tema -->
        <header class="text-center mb-6">
            <h1 class="font-display text-4xl md:text-6xl mb-4" style="color: var(--accent-secondary);">Control de Aforo</h1>
            <div class="flex justify-center space-x-2 md:space-x-4">
                <button id="theme-gothic" class="btn-theme active p-2 md:px-4 md:py-2 rounded-lg transition-all duration-300 bg-secondary hover:bg-tertiary" title="Cambiar a Estilo Gótico">Estilo I</button>
                <button id="theme-rocker" class="btn-theme p-2 md:px-4 md:py-2 rounded-lg transition-all duration-300 bg-secondary hover:bg-tertiary" title="Cambiar a Estilo Rockero">Estilo II</button>
                <button id="theme-retro" class="btn-theme p-2 md:px-4 md:py-2 rounded-lg transition-all duration-300 bg-secondary hover:bg-tertiary" title="Cambiar a Estilo Retro/Gaming">Estilo III</button>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Panel de Control -->
            <div class="bg-secondary p-4 rounded-lg shadow-lg flex flex-col space-y-4">
                <div class="text-center" title="Hora actual en la simulación (24 horas en 1 minuto)">
                    <h2 class="font-display text-2xl" style="color: var(--accent-primary);">Hora</h2>
                    <p id="clock" class="text-4xl font-bold font-mono text-primary">00:00</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-tertiary p-3 rounded" title="Número de mujeres actualmente en la sala">
                        <h3 class="text-lg font-bold" style="color: var(--woman-color);">Mujeres</h3>
                        <p id="women-count" class="text-3xl font-bold transition-transform duration-200">0</p>
                    </div>
                    <div class="bg-tertiary p-3 rounded" title="Número total de personas en la sala">
                        <h3 class="text-lg font-bold text-primary">Total</h3>
                        <p id="total-count" class="text-3xl font-bold transition-transform duration-200">0</p>
                    </div>
                    <div class="bg-tertiary p-3 rounded" title="Número de hombres actualmente en la sala">
                        <h3 class="text-lg font-bold" style="color: var(--man-color);">Hombres</h3>
                        <p id="men-count" class="text-3xl font-bold transition-transform duration-200">0</p>
                    </div>
                </div>

                <!-- Controles -->
                <div class="grid grid-cols-2 gap-4">
                     <!-- Columna Mujeres -->
                    <div class="flex flex-col items-center space-y-2">
                         <h4 class="font-bold text-xl" style="color: var(--woman-color);">Control Mujeres</h4>
                        <button id="add-woman" class="btn-control w-full accent-secondary text-on-accent text-lg font-bold py-3 rounded" title="Añadir una mujer">+</button>
                        <button id="remove-woman" class="btn-control w-full bg-tertiary border-2 border-accent text-lg font-bold py-3 rounded" title="Quitar una mujer">-</button>
                    </div>
                     <!-- Columna Hombres -->
                    <div class="flex flex-col items-center space-y-2">
                        <h4 class="font-bold text-xl" style="color: var(--man-color);">Control Hombres</h4>
                        <button id="add-man" class="btn-control w-full accent-primary text-on-accent text-lg font-bold py-3 rounded" title="Añadir un hombre">+</button>
                        <button id="remove-man" class="btn-control w-full bg-tertiary border-2 border-accent text-lg font-bold py-3 rounded" title="Quitar un hombre">-</button>
                    </div>
                </div>
                
                <!-- Entrada Personalizada -->
                 <div>
                    <h4 class="font-bold text-xl text-center mb-2">Entrada Personalizada</h4>
                    <div class="flex gap-2">
                        <input type="number" id="custom-number" min="1" class="w-full p-2 rounded bg-tertiary text-primary text-center" placeholder="Nº personas..." title="Introduce un número para añadir en grupo">
                        <button id="set-women" class="btn-control p-2 rounded text-on-accent" style="background-color: var(--woman-color);" title="Añadir el número especificado de mujeres">Mujeres</button>
                        <button id="set-men" class="btn-control p-2 rounded text-on-accent" style="background-color: var(--man-color);" title="Añadir el número especificado de hombres">Hombres</button>
                    </div>
                    <p class="text-xs text-secondary text-center mt-2">Aviso: Añadir un número muy alto puede afectar al rendimiento.</p>
                </div>
            </div>

            <!-- Panel de Visualización -->
            <div class="bg-secondary p-4 rounded-lg shadow-lg flex flex-col space-y-4">
                <h2 class="font-display text-2xl text-center" style="color: var(--accent-primary);">Sala de Eventos</h2>
                <div id="room" class="bg-tertiary rounded-lg" title="Visualización en tiempo real de las personas en la sala"></div>
                
                <!-- Contenedor de gráficos corregido -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-tertiary p-2 rounded chart-container" title="Gráfico de distribución por género">
                        <canvas id="genderChart"></canvas>
                    </div>
                    <div class="bg-tertiary p-2 rounded chart-container" title="Gráfico de flujo de personas (entradas y salidas) por hora">
                         <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DE LA APLICACIÓN ---
            let menCount = 0;
            let womenCount = 0;
            let peopleInRoom = [];
            let entryLog = [], departureLog = [];
            let simulatedTime = { hour: 0, minute: 0 };
            let personIdCounter = 0;
            const SIMULATION_SPEED = 20.83; // Milisegundos para simular 1 minuto (24h en 30s)

            // --- REFERENCIAS AL DOM ---
            const menCountEl = document.getElementById('men-count');
            const womenCountEl = document.getElementById('women-count');
            const totalCountEl = document.getElementById('total-count');
            const roomEl = document.getElementById('room');
            const clockEl = document.getElementById('clock');
            const customNumberInput = document.getElementById('custom-number');
            
            // --- GRÁFICOS (CHART.JS) ---
            let genderChart, timeChart;
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const timeCtx = document.getElementById('timeChart').getContext('2d');

            function initializeCharts() {
                // Configuración común para los gráficos
                Chart.defaults.color = 'rgba(224, 224, 224, 0.8)';
                Chart.defaults.font.family = "'Chakra Petch', sans-serif";

                genderChart = new Chart(genderCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hombres', 'Mujeres'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: [getComputedStyle(document.body).getPropertyValue('--man-color'), getComputedStyle(document.body).getPropertyValue('--woman-color')],
                            borderColor: getComputedStyle(document.body).getPropertyValue('--bg-tertiary'),
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Distribución por Género' }
                        }
                    }
                });

                timeChart = new Chart(timeCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [
                            {
                                label: 'Entradas Hombres',
                                data: new Array(24).fill(0),
                                backgroundColor: getComputedStyle(document.body).getPropertyValue('--man-color'),
                                stack: 'positive',
                            },
                            {
                                label: 'Entradas Mujeres',
                                data: new Array(24).fill(0),
                                backgroundColor: getComputedStyle(document.body).getPropertyValue('--woman-color'),
                                stack: 'positive',
                            },
                            {
                                label: 'Salidas Hombres',
                                data: new Array(24).fill(0),
                                backgroundColor: getComputedStyle(document.body).getPropertyValue('--man-color'),
                                stack: 'negative',
                            },
                            {
                                label: 'Salidas Mujeres',
                                data: new Array(24).fill(0),
                                backgroundColor: getComputedStyle(document.body).getPropertyValue('--woman-color'),
                                stack: 'negative',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            title: { display: true, text: 'Flujo de Personas por Hora' },
                            legend: { display: true, position: 'bottom', labels: { boxWidth: 20 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${Math.abs(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- LÓGICA DE ACTUALIZACIÓN ---
            function flashElement(el) {
                el.classList.add('flash-update');
                setTimeout(() => el.classList.remove('flash-update'), 400);
            }

            function updateCounters() {
                const oldMenCount = menCount;
                const oldWomenCount = womenCount;
                const oldTotal = menCount + womenCount;

                menCount = peopleInRoom.filter(p => p.gender === 'man').length;
                womenCount = peopleInRoom.filter(p => p.gender === 'woman').length;
                const total = menCount + womenCount;

                if(oldMenCount !== menCount) flashElement(menCountEl);
                if(oldWomenCount !== womenCount) flashElement(womenCountEl);
                if(oldTotal !== total) flashElement(totalCountEl);
                
                menCountEl.textContent = menCount;
                womenCountEl.textContent = womenCount;
                totalCountEl.textContent = total;
                updateCharts();
            }

            function updateCharts() {
                if (!genderChart || !timeChart) return;
                
                // Actualización del gráfico de género
                genderChart.data.datasets[0].data = [menCount, womenCount];
                genderChart.update('none');

                // Actualización del gráfico de flujo de tiempo
                const menHourlyEntries = new Array(24).fill(0);
                const womenHourlyEntries = new Array(24).fill(0);
                const menHourlyDepartures = new Array(24).fill(0);
                const womenHourlyDepartures = new Array(24).fill(0);

                entryLog.forEach(entry => {
                    if (entry.gender === 'man') {
                        menHourlyEntries[entry.time.hour]++;
                    } else {
                        womenHourlyEntries[entry.time.hour]++;
                    }
                });

                departureLog.forEach(entry => {
                    if (entry.gender === 'man') {
                        menHourlyDepartures[entry.time.hour]--;
                    } else {
                        womenHourlyDepartures[entry.time.hour]--;
                    }
                });

                timeChart.data.datasets[0].data = menHourlyEntries;
                timeChart.data.datasets[1].data = womenHourlyEntries;
                timeChart.data.datasets[2].data = menHourlyDepartures;
                timeChart.data.datasets[3].data = womenHourlyDepartures;
                timeChart.update('none');
            }

            // --- LÓGICA DE LA SIMULACIÓN DE TIEMPO ---
            function runClock() {
                simulatedTime.minute++;
                if (simulatedTime.minute >= 60) {
                    simulatedTime.minute = 0;
                    simulatedTime.hour++;
                    if (simulatedTime.hour >= 24) {
                        simulatedTime.hour = 0;
                        entryLog = []; // Opcional: reiniciar el log cada 24h
                        departureLog = [];
                    }
                }
                const displayHour = String(simulatedTime.hour).padStart(2, '0');
                const displayMinute = String(simulatedTime.minute).padStart(2, '0');
                clockEl.textContent = `${displayHour}:${displayMinute}`;
            }

            // --- LÓGICA DE ANIMACIÓN ---
            function addPersonToRoom(gender) {
                const person = {
                    id: personIdCounter++,
                    gender: gender,
                    el: document.createElement('div'),
                    x: Math.random() * (roomEl.clientWidth - 15),
                    y: Math.random() * (roomEl.clientHeight - 15),
                    vx: (Math.random() - 0.5) * 2, // Velocidad x
                    vy: (Math.random() - 0.5) * 2, // Velocidad y
                };
                
                person.el.className = `person ${gender} entering`;
                person.el.style.transform = `translate(${person.x}px, ${person.y}px)`;
                roomEl.appendChild(person.el);
                
                setTimeout(() => person.el.classList.remove('entering'), 100);

                peopleInRoom.push(person);
                entryLog.push({ gender: gender, time: { ...simulatedTime } });
                updateCounters();
            }
            
            function removePersonFromRoom(gender) {
                const personIndex = peopleInRoom.findIndex(p => p.gender === gender);
                if (personIndex > -1) {
                    const person = peopleInRoom[personIndex];
                    person.el.classList.add('leaving');
                    setTimeout(() => person.el.remove(), 500);
                    peopleInRoom.splice(personIndex, 1);
                    departureLog.push({ gender: gender, time: { ...simulatedTime } });
                    updateCounters();
                }
            }

            function animate() {
                peopleInRoom.forEach(person => {
                    person.x += person.vx;
                    person.y += person.vy;

                    if (person.x <= 0 || person.x >= roomEl.clientWidth - 15) person.vx *= -1;
                    if (person.y <= 0 || person.y >= roomEl.clientHeight - 15) person.vy *= -1;

                    person.el.style.transform = `translate(${person.x}px, ${person.y}px)`;
                });
                requestAnimationFrame(animate);
            }
            
            // --- LÓGICA DE TEMAS ---
            function setTheme(theme) {
                document.body.className = `bg-primary text-primary ${theme}`;
                document.querySelectorAll('.btn-theme').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.id === theme) btn.classList.add('active');
                });
                if (genderChart && timeChart) {
                    setTimeout(() => { // Pequeño delay para asegurar que las variables CSS se han aplicado
                        const manColor = getComputedStyle(document.body).getPropertyValue('--man-color');
                        const womanColor = getComputedStyle(document.body).getPropertyValue('--woman-color');
                        const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-tertiary');
                        const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');

                        // Actualizar gráfico de género (Doughnut)
                        genderChart.data.datasets[0].backgroundColor = [manColor, womanColor];
                        genderChart.data.datasets[0].borderColor = bgColor;
                        genderChart.options.plugins.title.color = textColor;
                        genderChart.options.plugins.legend.labels.color = textColor;

                        // Actualizar gráfico de tiempo (Barras)
                        timeChart.data.datasets[0].backgroundColor = manColor;
                        timeChart.data.datasets[1].backgroundColor = womanColor;
                        timeChart.data.datasets[2].backgroundColor = manColor;
                        timeChart.data.datasets[3].backgroundColor = womanColor;
                        timeChart.options.plugins.title.color = textColor;
                        timeChart.options.plugins.legend.labels.color = textColor;
                        timeChart.options.scales.x.ticks.color = textColor;
                        timeChart.options.scales.y.ticks.color = textColor;
                        timeChart.options.scales.x.grid.color = 'rgba(255, 255, 255, 0.1)';
                        timeChart.options.scales.y.grid.color = 'rgba(255, 255, 255, 0.1)';
                        
                        // Re-renderizar ambos gráficos con los nuevos colores y opciones
                        genderChart.update();
                        timeChart.update();
                    }, 50);
                }
            }

            // --- MANEJADORES DE EVENTOS ---
            document.getElementById('add-man').addEventListener('click', () => addPersonToRoom('man'));
            document.getElementById('remove-man').addEventListener('click', () => removePersonFromRoom('man'));
            document.getElementById('add-woman').addEventListener('click', () => addPersonToRoom('woman'));
            document.getElementById('remove-woman').addEventListener('click', () => removePersonFromRoom('woman'));
            
            document.getElementById('set-men').addEventListener('click', () => {
                const amount = parseInt(customNumberInput.value, 10);
                if (!isNaN(amount) && amount > 0) {
                    for(let i=0; i < amount; i++) addPersonToRoom('man');
                }
                customNumberInput.value = '';
            });
            document.getElementById('set-women').addEventListener('click', () => {
                const amount = parseInt(customNumberInput.value, 10);
                if (!isNaN(amount) && amount > 0) {
                    for(let i=0; i < amount; i++) addPersonToRoom('woman');
                }
                customNumberInput.value = '';
            });
            
            document.getElementById('theme-gothic').addEventListener('click', () => setTheme('theme-gothic'));
            document.getElementById('theme-rocker').addEventListener('click', () => setTheme('theme-rocker'));
            document.getElementById('theme-retro').addEventListener('click', () => setTheme('theme-retro'));

            // --- INICIALIZACIÓN ---
            initializeCharts();
            setTheme('theme-gothic');
            setInterval(runClock, SIMULATION_SPEED);
            requestAnimationFrame(animate);
            updateCounters();
        });
    </script>
</body>
</html>


